name: PR Checks & Enhancements

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Auto-label PRs based on files changed
  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label PR based on files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
        continue-on-error: true

  # Add size label based on lines changed
  size-label:
    name: Add Size Label
    runs-on: ubuntu-latest
    steps:
      - uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: '10'
          s_label: 'size/s'
          s_max_size: '100'
          m_label: 'size/m'
          m_max_size: '500'
          l_label: 'size/l'
          l_max_size: '1000'
          xl_label: 'size/xl'
          fail_if_xl: 'false'
        continue-on-error: true

  # Check if PR description is adequate
  pr-description-check:
    name: Check PR Description
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            if (body.length < 50) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'âš ï¸ **PR Description Too Short**\n\nPlease add a more detailed description of your changes. Good PR descriptions should include:\n- What changes were made\n- Why these changes were necessary\n- How to test the changes\n- Any breaking changes or migration notes'
              });
            }

  # Assign reviewers based on code ownership
  assign-reviewers:
    name: Assign Reviewers
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Auto assign reviewers
        uses: kentaro-m/auto-assign-action@v2.0.0
        with:
          configuration-path: '.github/auto-assign.yml'
        continue-on-error: true

  # Check for TODO/FIXME comments
  todo-check:
    name: Check TODOs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find TODOs
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            try {
              const todos = execSync('git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\\+.*TODO|^\\+.*FIXME" || true').toString();

              if (todos) {
                const comment = '## ðŸ“ New TODOs/FIXMEs Found\n\n```\n' + todos + '\n```\n\nPlease consider addressing these or creating issues for them.';

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('No TODOs found or error occurred:', error.message);
            }

  # Spell check
  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check spelling
        uses: crate-ci/typos@master
        with:
          files: ./src ./e2e *.md
          config: ./.typos.toml
        continue-on-error: true

  # Bundle size tracking
  bundle-size:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build -- --base-href /lixso/

      - name: Calculate and comment bundle size
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            try {
              const distPath = 'dist/lixso-game/browser';
              const totalSize = execSync(`du -sb ${distPath} | cut -f1`).toString().trim();
              const totalSizeMB = (parseInt(totalSize) / 1024 / 1024).toFixed(2);

              const files = fs.readdirSync(distPath)
                .filter(f => f.endsWith('.js') || f.endsWith('.css'))
                .map(f => {
                  const stats = fs.statSync(path.join(distPath, f));
                  return `- ${f}: ${(stats.size / 1024).toFixed(2)} KB`;
                });

              const comment = `## ðŸ“¦ Bundle Size Report\n\n**Total Size**: ${totalSizeMB} MB\n\n### Files:\n${files.join('\n')}\n\n---\n*This is an automated comment*`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Error calculating bundle size:', error.message);
            }
